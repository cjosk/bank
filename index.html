<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loot Bank - Team Supremacy</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg width='32' height='32' viewBox='0 0 32 32' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Crect width='32' height='32' rx='6' fill='%231A0B0B'/%3E%3Cpath d='M22 10C22 8 20 7 18 7H14C11.5 7 10 8.5 10 11V12C10 13.5 11 15 13 15H19C21 15 22 16.5 22 18V20C22 22.5 20.5 25 18 25H14C12 25 10 24 10 22' stroke='%23D79A34' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #111111;
            --bg-card: rgba(24, 24, 27, 0.6);
            --border-color: rgba(63, 63, 70, 0.5);
            --text-primary: #E4E4E7;
            --text-secondary: #A1A1AA;
            --accent-gold: #F59E0B; /* Amber 500 */
            --accent-red: #DC2626; /* Red 600 */
            --accent-green: #4ADE80; /* Green 400 */
            --discord-blue: #5865F2;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg-primary); 
            color: var(--text-primary);
            background-image: radial-gradient(circle at top left, rgba(245, 158, 11, 0.08), transparent 30%),
                              radial-gradient(circle at bottom right, rgba(39, 39, 42, 0.5), transparent 40%);
            background-attachment: fixed;
        }

        .card { 
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 1.25rem;
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        .form-input, .form-textarea { 
            background-color: rgba(17, 17, 17, 0.7); 
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            border-radius: 0.75rem;
            transition: all 0.2s ease;
        }

        .form-input:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--accent-gold);
            box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.4);
        }

        .btn {
            border-radius: 0.75rem;
            font-weight: 700;
            transition: all 0.2s ease;
            transform: scale(1);
        }
        .btn:hover {
            transform: scale(1.03);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: scale(1);
        }

        .btn-discord { background-color: var(--discord-blue); }
        .btn-discord:hover { background-color: #4752C4; }
        .btn-primary { background-color: var(--accent-gold); color: #111; }
        .btn-primary:hover { background-color: #D97706; }
        .btn-secondary { background-color: #3F3F46; color: var(--text-primary); }
        .btn-secondary:hover { background-color: #52525B; }
        .btn-success { background-color: #16A34A; color: white; }
        .btn-success:hover { background-color: #15803D; }

        .tab-button { 
            border-color: transparent; 
            transition: all 0.2s ease-in-out;
            color: var(--text-secondary);
            padding: 0.75rem 0.25rem;
            position: relative;
        }
        .tab-button.active { 
            color: var(--accent-gold);
        }
        .tab-button.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background-color: var(--accent-gold);
            border-radius: 2px;
        }
        .file-drop-area {
            border: 2px dashed var(--border-color);
            border-radius: 0.75rem;
        }
        .file-drop-area.highlight {
            border-color: var(--accent-gold);
            background-color: rgba(245, 158, 11, 0.1);
        }
    </style>
</head>
<body class="antialiased">

    <div class="w-full bg-black/30 p-4 flex items-center justify-center border-b border-zinc-800 backdrop-blur-sm sticky top-0 z-50">
        <img src="https://i.hizliresim.com/mred25t.png" alt="Team Supremacy Logo" class="h-10">
    </div>

    <div id="player-app" class="min-h-screen">
        <div id="login-view" class="flex items-center justify-center min-h-[80vh] p-4">
            <div class="w-full max-w-sm card p-8 shadow-2xl text-center">
                <h1 class="text-2xl font-bold text-white mb-2">Kontrol Paneli</h1>
                <p class="text-zinc-400 mb-6">Devam etmek için Discord hesabınla giriş yap.</p>
                <button id="discord-login-button" class="btn btn-discord w-full py-3 flex items-center justify-center gap-2">
                    <svg class="w-6 h-6" viewBox="0 0 24 24"><path fill="currentColor" d="M20.317 4.369a19.791 19.791 0 0 0-4.885-1.515a.074.074 0 0 0-.079.037c-.21.375-.443.805-.632 1.29a18.168 18.168 0 0 0-5.485 0a17.3 17.3 0 0 0-.632-1.29a.074.074 0 0 0-.08-.037a19.791 19.791 0 0 0-4.885 1.515a.069.069 0 0 0-.032.059a19.342 19.342 0 0 0-1.622 5.585a.078.078 0 0 0 .028.083a17.9 17.9 0 0 0 4.1 2.624a.074.074 0 0 0 .089-.022a1.171 1.171 0 0 1 .494-.325a.074.074 0 0 0 .018-.111a12.112 12.112 0 0 0-1.88-1.084a.074.074 0 0 1-.038-.062a15.777 15.777 0 0 1 .413-2.91a.075.075 0 0 0 .043-.075a1.189 1.189 0 0 1 .018-.043a1.17 1.17 0 0 1 .1-.141a.071.071 0 0 0 .034-.044Z M12 16.117c-1.933 0-3.5-1.72-3.5-3.857c0-2.137 1.567-3.857 3.5-3.857s3.5 1.72 3.5 3.857c0 2.137-1.567 3.857-3.5 3.857Zm-4.136-3.857c0 1.233 1.042 2.232 2.327 2.232c.1 0 .2-.014.3-.028a.074.074 0 0 0 .048-.066a1.17 1.17 0 0 1-.162-1.164a1.17 1.17 0 0 1 .162-.164a.073.073 0 0 0 .066-.048a.074.074 0 0 0 .028-.153a2.321 2.321 0 0 0-2.763 1.562Zm8.272 0c0 1.233 1.042 2.232 2.327 2.232c.1 0 .2-.014.3-.028a.074.074 0 0 0 .048-.066a1.17 1.17 0 0 1-.162-1.164a1.17 1.17 0 0 1 .162-.164a.073.073 0 0 0 .066-.048a.074.074 0 0 0 .028-.153a2.321 2.321 0 0 0-2.763 1.562Z"/></svg>
                    <span>Discord ile Giriş Yap</span>
                </button>
            </div>
        </div>

        <div id="link-account-view" class="hidden flex items-center justify-center min-h-[80vh] p-4">
            <div class="w-full max-w-sm card p-8 shadow-lg text-center">
                <img id="discord-avatar" class="w-20 h-20 rounded-full mx-auto mb-4 border-2" style="border-color: var(--accent-gold);">
                <h1 id="discord-username" class="text-xl font-bold text-white mb-2"></h1>
                <p class="text-zinc-400 mb-6">Hesabını bağlamak için oyundaki ismini gir.</p>
                <form id="link-account-form">
                    <input id="in-game-name-link" type="text" placeholder="Oyun-içi İsim" class="form-input w-full p-3 mb-4 text-center" required>
                    <button type="submit" class="btn btn-primary w-full py-3">Hesabı Bağla</button>
                </form>
            </div>
        </div>
       
        <div id="dashboard-view" class="hidden w-full max-w-7xl mx-auto p-4 sm:p-6 md:p-8">
            <header class="flex flex-col sm:flex-row justify-between items-center mb-8 pb-6 border-b border-zinc-700">
                <div class="flex items-center gap-4">
                    <img id="header-discord-avatar" src="" class="w-16 h-16 rounded-xl object-cover">
                    <div>
                        <h1 id="player-name" class="text-2xl font-extrabold text-white"></h1>
                        <p class="text-sm text-zinc-400">[SUP] Team Supremacy</p>
                    </div>
                </div>
                <div class="flex items-center gap-6 sm:gap-8 mt-6 sm:mt-0">
                    <div class="text-right">
                        <p class="text-xs text-zinc-400 font-medium tracking-wider">GUILD ALIŞ ORANI</p>
                        <div class="flex items-center justify-end gap-2 mt-1">
                            <p id="guild-purchase-rate" class="text-xl font-bold" style="color: var(--accent-gold);"></p>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" style="color: var(--accent-gold);" viewBox="0 0 20 20" fill="currentColor"><path d="M2 10.5a1.5 1.5 0 113 0v6a1.5 1.5 0 01-3 0v-6zM6 10.333V17a1.5 1.5 0 01-3 0v-6.667a1.5 1.5 0 013 0zM10 5.5a1.5 1.5 0 013 0v11.5a1.5 1.5 0 01-3 0V5.5zM14 8.333V17a1.5 1.5 0 01-3 0V8.333a1.5 1.5 0 013 0zM18 3v14a1.5 1.5 0 01-3 0V3a1.5 1.5 0 013 0z" /></svg>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="text-xs text-zinc-400 font-medium tracking-wider">GÜNCEL BAKİYEN</p>
                         <div class="flex items-center justify-end gap-2 mt-1">
                             <p id="player-balance" class="text-3xl font-bold" style="color: var(--accent-green);"></p>
                             <img src="https://i.hizliresim.com/tsb3m7q.png" class="w-8 h-8">
                         </div>
                    </div>
                </div>
            </header>
           
            <div class="flex justify-between items-center mb-8 border-b-2 border-zinc-800">
                <nav class="flex -mb-px space-x-6" aria-label="Tabs">
                    <button id="tab-action" class="tab-button active py-3 px-1 text-sm font-bold tracking-wider">YENİ İŞLEM</button>
                    <button id="tab-history" class="tab-button py-3 px-1 text-sm font-bold tracking-wider">İŞLEM GEÇMİŞİM</button>
                    <button id="tab-all-players" class="tab-button py-3 px-1 text-sm font-bold tracking-wider">TÜM OYUNCULAR</button>
                </nav>
                <button id="how-it-works-button" class="btn btn-secondary py-2 px-4 text-sm">Nasıl Çalışır?</button>
            </div>

            <div id="action-content">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="card p-6 lg:p-8">
                        <h2 class="text-xl font-bold mb-4" style="color: var(--accent-gold);">Örnek Satış Hesaplayıcı</h2>
                        <div class="space-y-4">
                            <div>
                                <label for="calc-total-value" class="block text-sm font-medium text-zinc-300">Toplam Satış Tutarı</label>
                                <input type="number" id="calc-total-value" class="form-input w-full p-2 mt-1" placeholder="10000000">
                            </div>
                            <div>
                                <label for="calc-repair-cost" class="block text-sm font-medium text-zinc-300">Toplam Tamir Masrafı</label>
                                <input type="number" id="calc-repair-cost" class="form-input w-full p-2 mt-1" placeholder="150000">
                            </div>
                            <div>
                                <label for="calc-party-count" class="block text-sm font-medium text-zinc-300">Parti Üye Sayısı</label>
                                <input type="number" id="calc-party-count" class="form-input w-full p-2 mt-1" placeholder="5">
                            </div>
                        </div>
                        <div class="mt-6 pt-4 border-t" style="border-color: var(--border-color);">
                            <div class="flex justify-between text-sm mt-2">
                                <span class="text-zinc-400">Kesinti Öncesi Net Tutar:</span>
                                <span id="calc-pre-tax" class="font-medium text-zinc-200">0</span>
                            </div>
                            <div class="flex justify-between text-sm mt-2">
                                <span class="text-zinc-400">Guild Alış Oranı (<span id="calc-tax-rate-display">%20</span>):</span>
                                <span id="calc-tax-amount" class="font-medium" style="color: var(--accent-red);">- 0</span>
                            </div>
                             <div class="flex justify-between text-lg font-bold mt-4">
                                <span class="text-white">Oyuncu Başına Düşen:</span>
                                <span id="calc-net-payout" style="color: var(--accent-green);">0 Silver</span>
                            </div>
                        </div>
                    </div>
                    <div class="space-y-8">
                        <div id="deposit-form-container" class="card p-6 lg:p-8">
                            <h2 class="text-xl font-bold mb-4">Loot Yatır</h2>
                            <form id="deposit-form" class="space-y-4">
                                <div>
                                    <label for="party-members" class="block text-sm font-medium text-zinc-300">Parti Üyeleri (Virgülle ayır)</label>
                                    <textarea id="party-members" rows="2" placeholder="Oyuncu1, Oyuncu2, Oyuncu3" class="form-textarea w-full p-2" required></textarea>
                                </div>
                                <div>
                                    <label for="estimated-value" class="block text-sm font-medium text-zinc-300">Tahmini Toplam Tab/Sandık Tutarı</label>
                                    <input type="number" id="estimated-value" placeholder="Örn: 15000000" class="form-input w-full p-2" required>
                                </div>
                                <div>
                                    <label for="repair-cost" class="block text-sm font-medium text-zinc-300">Toplam Tamir Masrafı (Repair Cost)</label>
                                    <input type="number" id="repair-cost" placeholder="Örn: 150000" class="form-input w-full p-2" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-zinc-300">Ekran Görüntüsü</label>
                                    <div id="file-drop-area" class="file-drop-area mt-1 p-6 text-center cursor-pointer transition-colors">
                                        <p id="file-info" class="text-zinc-400">Görseli buraya sürükle veya seçmek için tıkla</p>
                                        <input type="file" id="screenshot-file" class="hidden" accept="image/png, image/jpeg">
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-secondary w-full py-2.5">Loot Yatırma Talebi Gönder</button>
                            </form>
                        </div>
                         <div class="card p-6 lg:p-8">
                            <h2 class="text-xl font-bold mb-4">Silver Çek</h2>
                            <form id="withdraw-form">
                                <div class="mb-4">
                                     <label for="withdraw-amount" class="block text-sm font-medium text-zinc-300">Çekilecek Tutar</label>
                                    <input id="withdraw-amount" type="number" placeholder="Örn: 5000000" class="form-input w-full p-2 mt-1" required>
                                </div>
                                <button type="submit" class="btn btn-success w-full py-2.5">Çekim Talebi Oluştur</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <div id="history-content" class="hidden">
                 <h2 class="text-xl font-bold mb-4 text-white">Tüm İşlemlerim</h2>
                 <div id="user-history-list" class="space-y-4">
                     <p class="text-center text-zinc-400">Henüz bir işlem yapmadınız.</p>
                 </div>
            </div>

            <div id="all-players-content" class="hidden">
                <div class="mb-6">
                    <input type="text" id="player-search-input" placeholder="Oyuncu adı ara..." class="form-input w-full max-w-md p-3">
                </div>
                <div id="all-players-list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                    <!-- All players will be dynamically inserted here -->
                    <p class="text-zinc-400 col-span-full">Oyuncu listesi yükleniyor...</p>
                </div>
            </div>
        </div>
    </div>
   
    <!-- Send Money Modal -->
    <div id="send-money-modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50">
        <div class="card w-full max-w-md p-6">
            <h2 class="text-xl font-bold mb-2 text-white">Bakiye Gönder</h2>
            <p class="text-zinc-400 mb-4">Hedef Oyuncu: <span id="modal-player-name" class="font-bold text-amber-400"></span></p>
            <form id="send-money-form" class="space-y-4">
                <div>
                    <label for="modal-transfer-amount" class="block text-sm font-medium text-zinc-300">Gönderilecek Tutar</label>
                    <input id="modal-transfer-amount" type="number" placeholder="Örn: 1000000" class="form-input w-full p-2 mt-1" required>
                </div>
                <div>
                    <label for="modal-transfer-note" class="block text-sm font-medium text-zinc-300">Not (İsteğe bağlı)</label>
                    <textarea id="modal-transfer-note" placeholder="Transfer notu..." class="form-textarea w-full p-2 mt-1" rows="2"></textarea>
                </div>
                <div class="flex items-center gap-4 pt-2">
                    <button type="button" id="modal-close-button" class="btn btn-secondary w-full py-2.5">İptal</button>
                    <button type="submit" id="modal-send-button" class="btn btn-success w-full py-2.5">Gönder</button>
                </div>
            </form>
        </div>
    </div>

    <!-- How It Works Modal -->
    <div id="how-it-works-modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50">
        <div class="card w-full max-w-2xl p-6 lg:p-8 relative">
            <button id="how-it-works-close-button" class="absolute top-4 right-4 text-zinc-400 hover:text-white transition-colors z-10">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <h2 class="text-2xl font-bold mb-6 text-amber-400 text-center">Panel Nasıl Çalışır?</h2>
            <div class="text-zinc-300 space-y-5 max-h-[70vh] overflow-y-auto pr-4 text-base">
                <div>
                    <h3 class="font-bold text-lg text-white mb-2">1. Adım: Giriş ve Hesap Bağlama</h3>
                    <p>Panele erişmek için Discord hesabınızla giriş yapmanız gerekmektedir. İlk girişinizde, sistem Discord hesabınızı oyundaki karakterinizle eşleştirmek için oyun içi isminizi soracaktır. Bu işlemi sadece bir kez yapmanız yeterlidir.</p>
                </div>
                <div>
                    <h3 class="font-bold text-lg text-white mb-2">2. Adım: Bakiye Sistemi</h3>
                    <p>Bu panel, guild'imizin ortak kasasını yönetmek için bir banka gibi çalışır. Yatırdığınız loot'lar silver'a dönüştürülür ve kişisel bakiyenize eklenir. Bakiyenizle diğer oyunculara transfer yapabilir veya silver olarak çekebilirsiniz.</p>
                </div>
                <div>
                    <h3 class="font-bold text-lg text-white mb-2">3. Adım: Loot Yatırma</h3>
                    <p>Kazandığınız loot'ları guild kasasına yatırmak için "Yeni İşlem" sekmesindeki "Loot Yatır" formunu kullanın. Formda partideki üyeleri, tahmini loot değerini ve tamir masrafını belirtip, istatistiklerin göründüğü bir ekran görüntüsü yüklemeniz gerekir. Talebiniz bir yetkili tarafından incelendikten sonra onaylanır ve bakiye hesaba eklenir.</p>
                </div>
                <div>
                    <h3 class="font-bold text-lg text-white mb-2">4. Adım: Silver Çekme</h3>
                    <p>Bakiyenizdeki silver'ı oyunda teslim almak için "Silver Çek" formunu kullanın. Çekmek istediğiniz tutarı girdiğinizde talebiniz yetkililere iletilir ve en kısa sürede oyun içinde size teslimatı yapılır.</p>
                </div>
                <div>
                    <h3 class="font-bold text-lg text-white mb-2">5. Adım: Oyuncular Arası Transfer</h3>
                    <p>"Tüm Oyuncular" sekmesinden guild'deki herhangi bir oyuncuya kolayca ve güvenli bir şekilde bakiye transferi yapabilirsiniz. Oyuncunun ismine tıklayıp göndermek istediğiniz tutarı girmeniz yeterlidir. Bu işlem anında gerçekleşir ve kayıt altına alınır.</p>
                </div>
                 <div>
                    <h3 class="font-bold text-lg text-white mb-2">6. Adım: İşlem Geçmişi</h3>
                    <p>"İşlem Geçmişim" sekmesinden tüm para yatırma, çekme ve transfer işlemlerinizin durumunu ve detaylarını takip edebilirsiniz.</p>
                </div>
                <div class="pt-4 border-t border-zinc-700">
                    <p class="text-sm text-amber-400 font-semibold">Önemli Not: Tüm işlemler şeffaflık ve güvenlik amacıyla kayıt altına alınmaktadır. Herhangi bir sorun yaşamanız durumunda yetkililerle iletişime geçebilirsiniz.</p>
                </div>
            </div>
        </div>
    </div>

    <div id="notification" class="fixed top-24 right-5 text-white py-2 px-5 rounded-lg shadow-lg hidden card"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, collection, serverTimestamp, query, where, onSnapshot, getDocs, writeBatch, setDoc, or } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        const DISCORD_CLIENT_ID = "1412951643741356215";

        const firebaseConfig = {
          apiKey: "AIzaSyC-yUauI8_nz4Ymc-BvHado5zoushIwQk4",
          authDomain: "bank-8a.firebaseapp.com",
          projectId: "bank-8738a",
          storageBucket: "bank-8738a.firebasestorage.app",
          messagingSenderId: "157747262596",
          appId: "1:157747262596:web:1f60a45a33c0c5a702fed1",
          measurementId: "G-T8Z3R2X6DJ"
        };

        const appId = firebaseConfig.appId || 'default-albion-app'; 

        let app, auth, db, storage;
        let currentUser = null;
        let guildSettings = { taxRate: 0.20 }; 
        let tempDiscordUser = null; 
        let targetPlayerForTransfer = null;

        const loginView = document.getElementById('login-view');
        const linkAccountView = document.getElementById('link-account-view');
        const dashboardView = document.getElementById('dashboard-view');
        const notification = document.getElementById('notification');
        const actionContent = document.getElementById('action-content');
        const historyContent = document.getElementById('history-content');
        const allPlayersContent = document.getElementById('all-players-content');
        const tabAction = document.getElementById('tab-action');
        const tabHistory = document.getElementById('tab-history');
        const tabAllPlayers = document.getElementById('tab-all-players');
        const sendMoneyModal = document.getElementById('send-money-modal');
        const howItWorksModal = document.getElementById('how-it-works-modal');
        const howItWorksButton = document.getElementById('how-it-works-button');
        const howItWorksCloseButton = document.getElementById('how-it-works-close-button');


        function formatSilver(num) {
            num = Number(num);
            if (isNaN(num)) return '0';
            if (Math.abs(num) >= 1000000) return (num / 1000000).toLocaleString('tr-TR', { minimumFractionDigits: 0, maximumFractionDigits: 2 }) + 'M';
            if (Math.abs(num) >= 1000) return (num / 1000).toLocaleString('tr-TR', { minimumFractionDigits: 0, maximumFractionDigits: 2 }) + 'K';
            return num.toLocaleString('tr-TR');
        }

        function showNotification(message, isError = false) {
            notification.textContent = message;
            notification.style.backgroundColor = isError ? 'var(--accent-red)' : 'var(--accent-green)';
            notification.classList.remove('hidden');
            setTimeout(() => notification.classList.add('hidden'), 3000);
        }

        document.getElementById('discord-login-button').addEventListener('click', () => {
            const redirectUri = window.location.origin + window.location.pathname;
            const scope = 'identify';
            const authUrl = `https://discord.com/api/oauth2/authorize?client_id=${DISCORD_CLIENT_ID}&redirect_uri=${encodeURIComponent(redirectUri)}&response_type=token&scope=${scope}`;
            window.location.href = authUrl;
        });
       
        async function handleDiscordRedirect() {
            const fragment = new URLSearchParams(window.location.hash.substring(1));
            const accessToken = fragment.get('access_token');
            if (!accessToken) return;
            window.history.replaceState({}, document.title, window.location.pathname);

            try {
                const response = await fetch('https://discordapp.com/api/users/@me', { headers: { 'Authorization': `Bearer ${accessToken}` } });
                if (!response.ok) throw new Error('Discord bilgileri alınamadı.');
               
                const discordUser = await response.json();
                tempDiscordUser = discordUser;

                const usersRef = collection(db, `artifacts/${appId}/public/data/users`);
                const q = query(usersRef, where("discordId", "==", discordUser.id));
                const snapshot = await getDocs(q);

                if (snapshot.empty) {
                    loginView.classList.add('hidden');
                    linkAccountView.classList.remove('hidden');
                    if (tempDiscordUser.avatar) {
                        document.getElementById('discord-avatar').src = `https://cdn.discordapp.com/avatars/${tempDiscordUser.id}/${tempDiscordUser.avatar}.png`;
                    } else {
                        const defaultAvatarIndex = (parseInt(tempDiscordUser.id) >> 22) % 6;
                        document.getElementById('discord-avatar').src = `https://cdn.discordapp.com/embed/avatars/${defaultAvatarIndex}.png`;
                    }
                    document.getElementById('discord-username').textContent = tempDiscordUser.username;
                } else {
                    const userDoc = snapshot.docs[0];
                    const userData = userDoc.data();
                    currentUser = { id: userDoc.id, ...userData };

                    if (userData.discordAvatar !== tempDiscordUser.avatar) {
                         const userRef = doc(db, `artifacts/${appId}/public/data/users`, userDoc.id);
                         await setDoc(userRef, { discordAvatar: tempDiscordUser.avatar }, { merge: true });
                         currentUser.discordAvatar = tempDiscordUser.avatar;
                    }
                    localStorage.setItem('loggedInUser', JSON.stringify(currentUser));
                    showDashboard();
                }
            } catch (error) {
                console.error("Discord auth error:", error);
                showNotification("Discord ile giriş yapılırken bir hata oluştu.", true);
            }
        }

        document.getElementById('link-account-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const inGameName = document.getElementById('in-game-name-link').value.trim();
            if (!inGameName || !tempDiscordUser) return;

            const nameLower = inGameName.toLowerCase();
            const usersRef = collection(db, `artifacts/${appId}/public/data/users`);
            const batch = writeBatch(db);
            const qNick = query(usersRef, where("inGameName_lowercase", "==", nameLower));
            const nickSnapshot = await getDocs(qNick);

            if (nickSnapshot.empty) {
                return showNotification("Bu isim guild listesinde bulunamadı. Lütfen admin ile görüşün.", true);
            }

            const userDoc = nickSnapshot.docs[0];
            if (userDoc.data().discordId) {
                return showNotification("Bu oyun içi isim zaten başka bir Discord hesabına bağlı.", true);
            }

            batch.update(userDoc.ref, { 
                discordId: tempDiscordUser.id,
                discordUsername: tempDiscordUser.username,
                discordAvatar: tempDiscordUser.avatar
            });

            const logRef = doc(collection(db, `artifacts/${appId}/public/data/registration_logs`));
            batch.set(logRef, {
                discordId: tempDiscordUser.id,
                discordUsername: tempDiscordUser.username,
                inGameName: userDoc.data().inGameName,
                timestamp: serverTimestamp()
            });

            await batch.commit();

            showNotification("Hesap başarıyla bağlandı!");
            currentUser = { id: userDoc.id, ...userDoc.data(), discordId: tempDiscordUser.id, discordUsername: tempDiscordUser.username, discordAvatar: tempDiscordUser.avatar };
            localStorage.setItem('loggedInUser', JSON.stringify(currentUser));
            linkAccountView.classList.add('hidden');
            showDashboard();
        });

        function listenForAllPlayers() {
            const listEl = document.getElementById('all-players-list');
            const usersRef = collection(db, `artifacts/${appId}/public/data/users`);
            
            onSnapshot(usersRef, (snapshot) => {
                if (snapshot.empty) {
                    listEl.innerHTML = `<p class="text-zinc-400 col-span-full">Guild'de hiç oyuncu bulunamadı.</p>`;
                    return;
                }
                
                const players = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                players.sort((a, b) => a.inGameName.localeCompare(b.inGameName));

                const playersHtml = players.map(player => {
                    const avatarUrl = 'https://render.albiononline.com/v1/destiny/ADVENTURER_ADEPT.png?locale=en';
                    return `
                        <div class="card p-4 flex items-center gap-4 cursor-pointer hover:border-amber-400 transition-colors player-card" data-player-id="${player.id}" data-player-name="${player.inGameName}">
                            <img src="${avatarUrl}" class="w-12 h-12 rounded-full bg-zinc-800">
                            <div>
                                <p class="font-bold text-white">${player.inGameName}</p>
                            </div>
                        </div>
                    `;
                }).join('');
                listEl.innerHTML = playersHtml;
            }, (error) => {
                console.error("Tüm oyuncular dinlenirken hata:", error);
                listEl.innerHTML = `<p class="text-red-400 col-span-full">Oyuncu listesi yüklenemedi. Lütfen yöneticiye bildirin.</p>`;
            });
        }
       
        async function showDashboard() {
            loginView.classList.add('hidden');
            linkAccountView.classList.add('hidden');
            dashboardView.classList.remove('hidden');
            document.getElementById('player-name').textContent = currentUser.inGameName;
           
            document.getElementById('header-discord-avatar').src = 'https://i.ibb.co/JWqfJVHv/Ekran-g-r-nt-s-2025-09-06-000957-removebg-preview.png';
           
            await loadGuildSettings();

            const userRef = doc(db, `artifacts/${appId}/public/data/users`, currentUser.id);
            onSnapshot(userRef, (doc) => {
                if(doc.exists()){
                    const userData = doc.data();
                    currentUser.balance = userData.balance || 0;
                    document.getElementById('player-balance').textContent = `${formatSilver(currentUser.balance)} Silver`;
                }
            });
            listenToUserHistory();
            listenForAllPlayers();
        }
       
        document.getElementById('deposit-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const button = e.target.querySelector('button[type="submit"]');
            const fileInput = document.getElementById('screenshot-file');
            const file = fileInput.files[0];
            const partyMembers = document.getElementById('party-members').value.split(',').map(m => m.trim()).filter(m => m);
            const repairCost = parseInt(document.getElementById('repair-cost').value) || 0;
            const estimatedValue = parseInt(document.getElementById('estimated-value').value) || 0;

            if (partyMembers.length === 0) return showNotification("Parti üyelerini girin.", true);
            if (!file) return showNotification("Ekran görüntüsü seçin.", true);

            button.disabled = true; button.textContent = "Yükleniyor...";

            try {
                const authUser = auth.currentUser;
                if (!authUser) throw new Error("Kimlik doğrulaması yapılamadı. Lütfen sayfayı yenileyin.");

                const filePath = `deposits/${authUser.uid}/${Date.now()}-${file.name}`;
                const storageRef = ref(storage, filePath);
                const uploadResult = await uploadBytes(storageRef, file);
                const imageUrl = await getDownloadURL(uploadResult.ref);

                await addDoc(collection(db, `artifacts/${appId}/public/data/deposits`), {
                    submitterId: currentUser.id, submitterName: currentUser.inGameName, partyMembers: partyMembers,
                    estimatedValue: estimatedValue, repairCost: repairCost, imageUrl: imageUrl, status: 'pending',
                    submittedAt: serverTimestamp()
                });
               
                showNotification("Loot yatırma talebi başarıyla gönderildi.");
                e.target.reset();
                document.getElementById('file-info').textContent = 'Görseli buraya sürükle veya seçmek için tıkla';
            } catch (error) {
                console.error("Deposit error:", error);
                showNotification("Talep gönderilirken hata oluştu.", true);
            } finally {
                button.disabled = false; button.textContent = "Loot Yatırma Talebi Gönder";
            }
        });

        document.getElementById('withdraw-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const amount = parseInt(document.getElementById('withdraw-amount').value);
            if (!amount || amount <= 0) return showNotification("Geçerli bir tutar girin.", true);
            if (amount > currentUser.balance) return showNotification("Bakiyeniz yetersiz.", true);
           
            await addDoc(collection(db, `artifacts/${appId}/public/data/withdrawals`), {
                requesterId: currentUser.id, requesterName: currentUser.inGameName, amount: amount,
                status: 'pending', requestedAt: serverTimestamp()
            });

            showNotification("Çekim talebi oluşturuldu.");
            e.target.reset();
        });

        function listenToUserHistory() {
            const historyListEl = document.getElementById('user-history-list');
            
            const qDeposits = query(collection(db, `artifacts/${appId}/public/data/deposits`), where("submitterId", "==", currentUser.id));
            const qWithdrawals = query(collection(db, `artifacts/${appId}/public/data/withdrawals`), where("requesterId", "==", currentUser.id));
            const qTransfers = query(collection(db, `artifacts/${appId}/public/data/transfers`), or(where("fromId", "==", currentUser.id), where("toId", "==", currentUser.id)));
            
            const unsubscribes = [
                onSnapshot(qDeposits, renderHistory),
                onSnapshot(qWithdrawals, renderHistory),
                onSnapshot(qTransfers, renderHistory)
            ];
            
            async function renderHistory() {
                const [depositsSnap, withdrawalsSnap, transfersSnap] = await Promise.all([
                    getDocs(qDeposits), getDocs(qWithdrawals), getDocs(qTransfers)
                ]);

                const deposits = depositsSnap.docs.map(doc => ({ id: doc.id, type: 'Loot Yatırma', ...doc.data() }));
                const withdrawals = withdrawalsSnap.docs.map(doc => ({ id: doc.id, type: 'Silver Çekim', ...doc.data() }));
                const transfers = transfersSnap.docs.map(doc => ({ id: doc.id, type: 'Transfer', ...doc.data() }));

                const allHistory = [...deposits, ...withdrawals, ...transfers].sort((a, b) => {
                    const dateA = a.timestamp || a.processedAt || a.submittedAt || a.requestedAt;
                    const dateB = b.timestamp || b.processedAt || b.submittedAt || b.requestedAt;
                    if (!dateA || !dateB) return 0; 
                    return dateB.toDate() - dateA.toDate();
                });

                if (allHistory.length === 0) {
                    historyListEl.innerHTML = `<p class="text-center text-zinc-400">Henüz bir işlem yapmadınız.</p>`;
                    return;
                }

                historyListEl.innerHTML = allHistory.map(item => {
                    const date = (item.timestamp || item.processedAt || item.submittedAt || item.requestedAt)?.toDate()?.toLocaleString('tr-TR') || 'Tarih Yok';
                    
                    if (item.type === 'Transfer') {
                        const isSender = item.fromId === currentUser.id;
                        const otherPlayer = isSender ? item.toName : item.fromName;
                        const amountClass = isSender ? 'text-red-400' : 'text-green-400';
                        const prefix = isSender ? '-' : '+';
                        const title = isSender ? `${otherPlayer} adlı oyuncuya gönderildi` : `${otherPlayer} adlı oyuncudan alındı`;
                        const noteHtml = item.note ? `<p class="text-xs text-zinc-400 mt-1 italic">"${item.note}"</p>` : '';
                        return `<div class="card p-4"><div class="flex justify-between items-start"><div><p class="font-bold">${title}</p><p class="text-sm font-semibold ${amountClass}">${prefix}${formatSilver(item.amount || 0)} Silver</p>${noteHtml}</div><div class="text-right flex-shrink-0 ml-4"><span class="text-xs font-bold text-white px-2 py-1 rounded-full bg-blue-500">Transfer</span><p class="text-xs text-zinc-400 mt-2">${date}</p></div></div></div>`;
                    }
                    
                    let statusClass, statusText;
                    switch (item.status) {
                        case 'completed': statusClass = 'bg-green-600'; statusText = 'Onaylandı'; break;
                        case 'rejected': statusClass = 'bg-red-600'; statusText = 'Reddedildi'; break;
                        default: statusClass = 'bg-yellow-500'; statusText = 'Beklemede';
                    }
                    const reasonHtml = item.status === 'rejected' && item.rejectionReason ? `<p class="text-xs mt-1" style="color:var(--accent-red);">${item.rejectionReason}</p>` : '';
                    let detailsHtml = '';
                     if (item.type === 'Loot Yatırma') {
                        const finalPayout = (item.finalValue || 0) / (item.partyMembers?.length || 1);
                        const payoutText = item.status === 'completed' ? ` | Oyuncu Başı: <span class="font-semibold text-green-400">${formatSilver(finalPayout)}</span>` : ``;
                        const estimatedValueText = `Tahmini Değer: <span class="font-semibold text-zinc-200">${formatSilver(item.estimatedValue || 0)}</span>`;
                        const repairCostText = `Tamir: <span class="font-semibold text-zinc-200">${formatSilver(item.repairCost || 0)}</span>`;
                        const screenshotLink = item.imageUrl ? `<a href="${item.imageUrl}" target="_blank" style="color:var(--accent-gold);" class="hover:underline">Görsel</a>` : '';
                        
                        detailsHtml = `<div class="text-xs text-zinc-400 mt-2 flex flex-wrap gap-x-4 gap-y-1">${estimatedValueText} | ${repairCostText} | ${screenshotLink}${payoutText}</div>`;
                    }
                    
                    const amountText = item.type === 'Silver Çekim' ? `${formatSilver(item.amount || 0)} Silver` : `Parti: ${(item.partyMembers || []).join(', ')}`;
                    
                    return `<div class="card p-4"><div class="flex justify-between items-start"><div><p class="font-bold">${item.type}</p><p class="text-sm text-zinc-300">${amountText}</p>${detailsHtml}${reasonHtml}</div><div class="text-right flex-shrink-0 ml-4"><span class="text-xs font-bold text-white px-2 py-1 rounded-full ${statusClass}">${statusText}</span><p class="text-xs text-zinc-400 mt-2">${date}</p></div></div></div>`;
                }).join('');
            };
        }
       
        const calcInputs = ['calc-total-value', 'calc-repair-cost', 'calc-party-count'];
        calcInputs.forEach(id => document.getElementById(id).addEventListener('input', calculatePayout));
       
        function calculatePayout() {
            const totalValue = parseInt(document.getElementById('calc-total-value').value) || 0;
            const repairCost = parseInt(document.getElementById('calc-repair-cost').value) || 0;
            const partyCount = parseInt(document.getElementById('calc-party-count').value) || 1;
           
            const preTax = totalValue - repairCost;
            const taxAmount = preTax > 0 ? preTax * guildSettings.taxRate : 0;
            const finalAmount = preTax - taxAmount;
            const perPlayer = partyCount > 0 ? finalAmount / partyCount : 0;
           
            document.getElementById('calc-pre-tax').textContent = formatSilver(preTax);
            document.getElementById('calc-tax-amount').textContent = `- ${formatSilver(taxAmount)}`;
            document.getElementById('calc-net-payout').textContent = `${formatSilver(perPlayer)} Silver`;
        }
       
        async function loadGuildSettings() {
            const settingsRef = doc(db, `artifacts/${appId}/public/data/settings`, 'guild');
            const docSnap = await getDoc(settingsRef);
            if (docSnap.exists() && docSnap.data().taxRate !== undefined) {
                guildSettings = docSnap.data();
            }
            const purchaseRate = Math.round((1 - guildSettings.taxRate) * 100);
            document.getElementById('guild-purchase-rate').textContent = `%${purchaseRate}`;
            document.getElementById('calc-tax-rate-display').textContent = `%${(guildSettings.taxRate * 100).toFixed(0)}`;
            calculatePayout();
        }

        // Tab Switching Logic
        function switchTab(activeTab) {
            [tabAction, tabHistory, tabAllPlayers].forEach(tab => tab.classList.remove('active'));
            [actionContent, historyContent, allPlayersContent].forEach(content => content.classList.add('hidden'));
            activeTab.button.classList.add('active');
            activeTab.content.classList.remove('hidden');
        }
        tabAction.addEventListener('click', () => switchTab({ button: tabAction, content: actionContent }));
        tabHistory.addEventListener('click', () => switchTab({ button: tabHistory, content: historyContent }));
        tabAllPlayers.addEventListener('click', () => switchTab({ button: tabAllPlayers, content: allPlayersContent }));


        // Player Search Filter Logic
        document.getElementById('player-search-input').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const players = document.querySelectorAll('#all-players-list .player-card');
            players.forEach(player => {
                const playerName = player.dataset.playerName.toLowerCase();
                if (playerName.includes(searchTerm)) {
                    player.style.display = 'flex';
                } else {
                    player.style.display = 'none';
                }
            });
        });

        // Send Money Modal Logic
        document.getElementById('all-players-list').addEventListener('click', (e) => {
            const card = e.target.closest('.player-card');
            if (card) {
                const playerId = card.dataset.playerId;
                const playerName = card.dataset.playerName;
                if (playerId === currentUser.id) {
                    showNotification("Kendinize bakiye gönderemezsiniz.", true);
                    return;
                }
                targetPlayerForTransfer = { id: playerId, name: playerName };
                document.getElementById('modal-player-name').textContent = playerName;
                sendMoneyModal.classList.remove('hidden');
            }
        });

        function closeModal() {
            sendMoneyModal.classList.add('hidden');
            document.getElementById('send-money-form').reset();
            targetPlayerForTransfer = null;
        }
        document.getElementById('modal-close-button').addEventListener('click', closeModal);
        sendMoneyModal.addEventListener('click', (e) => { if(e.target === sendMoneyModal) closeModal(); });
        
        document.getElementById('send-money-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const amountInput = document.getElementById('modal-transfer-amount');
            const noteInput = document.getElementById('modal-transfer-note');
            const sendButton = document.getElementById('modal-send-button');
            const amount = parseInt(amountInput.value);
            const note = noteInput.value.trim();

            if (!targetPlayerForTransfer || !amount || amount <= 0) {
                return showNotification("Lütfen geçerli bir tutar girin.", true);
            }
            if (amount > currentUser.balance) {
                return showNotification("Bakiyeniz bu transfer için yetersiz.", true);
            }
            
            sendButton.disabled = true;
            sendButton.textContent = "Gönderiliyor...";
            
            try {
                const fromRef = doc(db, `artifacts/${appId}/public/data/users`, currentUser.id);
                const toRef = doc(db, `artifacts/${appId}/public/data/users`, targetPlayerForTransfer.id);
                
                const batch = writeBatch(db);
                
                const toDoc = await getDoc(toRef);
                if (!toDoc.exists()) throw new Error("Alıcı kullanıcı bulunamadı.");
                const receiverData = toDoc.data();

                const newSenderBalance = currentUser.balance - amount;
                const newReceiverBalance = (receiverData.balance || 0) + amount;
                
                batch.update(fromRef, { balance: newSenderBalance });
                batch.update(toRef, { balance: newReceiverBalance });

                const transferLogRef = doc(collection(db, `artifacts/${appId}/public/data/transfers`));
                const transferData = {
                    fromId: currentUser.id, fromName: currentUser.inGameName,
                    toId: targetPlayerForTransfer.id, toName: targetPlayerForTransfer.name,
                    amount: amount, timestamp: serverTimestamp()
                };
                if (note) {
                    transferData.note = note;
                }
                batch.set(transferLogRef, transferData);

                await batch.commit();

                showNotification(`${formatSilver(amount)} silver, ${targetPlayerForTransfer.name} adlı oyuncuya başarıyla gönderildi.`);
                closeModal();
            } catch (error) {
                console.error("Transfer error: ", error);
                showNotification("Transfer sırasında bir hata oluştu.", true);
            } finally {
                sendButton.disabled = false;
                sendButton.textContent = "Gönder";
            }
        });
        
        // How It Works Modal Logic
        howItWorksButton.addEventListener('click', () => {
            howItWorksModal.classList.remove('hidden');
        });

        function closeHowItWorksModal() {
            howItWorksModal.classList.add('hidden');
        }

        howItWorksCloseButton.addEventListener('click', closeHowItWorksModal);
        howItWorksModal.addEventListener('click', (e) => {
            if (e.target === howItWorksModal) {
                closeHowItWorksModal();
            }
        });


        // File Drop Area Logic
        const dropArea = document.getElementById('file-drop-area');
        const fileInput = document.getElementById('screenshot-file');
        const fileInfo = document.getElementById('file-info');
        dropArea.addEventListener('click', () => fileInput.click());
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => dropArea.addEventListener(eventName, (e) => { e.preventDefault(); e.stopPropagation(); }));
        ['dragenter', 'dragover'].forEach(eventName => dropArea.addEventListener(eventName, () => dropArea.classList.add('highlight')));
        ['dragleave', 'drop'].forEach(eventName => dropArea.addEventListener(eventName, () => dropArea.classList.remove('highlight')));
        dropArea.addEventListener('drop', (e) => {
            fileInput.files = e.dataTransfer.files;
            fileInfo.textContent = fileInput.files[0].name;
        });
        fileInput.addEventListener('change', () => { if(fileInput.files.length > 0) fileInfo.textContent = fileInput.files[0].name; });
       
        async function initializeAppAndAuth() {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            storage = getStorage(app);
            try {
                await signInAnonymously(auth);
                const savedUser = localStorage.getItem('loggedInUser');
                if (savedUser) {
                    currentUser = JSON.parse(savedUser);
                    showDashboard();
                } else {
                    await handleDiscordRedirect();
                }
            } catch (error) { console.error("Auth error", error); }
        }

        initializeAppAndAuth();
    </script>
</body>
</html>

