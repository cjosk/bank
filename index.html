<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Klan Kasası</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #1a202c; color: #e2e8f0; }
        .form-input, .form-textarea { background-color: #2d3748; border-color: #4a5568; color: #e2e8f0; }
        .card { background-color: #2d3748; border: 1px solid #4a5568; }
        .btn-discord { background-color: #5865F2; }
        .btn-discord:hover { background-color: #4752C4; }
        .btn-primary { background-color: #4f46e5; }
        .btn-primary:hover { background-color: #4338ca; }
        .file-drop-area { border: 2px dashed #4a5568; }
        .file-drop-area.highlight { border-color: #a0aec0; background-color: #4a5568; }
        .tab-button { border-color: transparent; }
        .tab-button.active { border-color: #4f46e5; color: white; }
    </style>
</head>
<body class="antialiased">

    <div id="player-app" class="min-h-screen">
        <div id="login-view" class="flex items-center justify-center min-h-screen p-4">
            <div class="w-full max-w-sm card p-8 rounded-lg shadow-lg text-center">
                <h1 class="text-2xl font-bold text-white mb-2">Klan Kasasına Hoş Geldin</h1>
                <p class="text-gray-400 mb-6">Devam etmek için Discord hesabınla giriş yap.</p>
                <button id="discord-login-button" class="w-full py-3 rounded-md font-bold text-white btn-discord flex items-center justify-center gap-2">
                    <svg class="w-6 h-6" aria-hidden="true" role="img" width="24" height="24" preserveAspectRatio="xMidYMid meet" viewBox="0 0 24 24"><path fill="currentColor" d="M20.317 4.369a19.791 19.791 0 0 0-4.885-1.515a.074.074 0 0 0-.079.037c-.21.375-.443.805-.632 1.29a18.168 18.168 0 0 0-5.485 0a17.3 17.3 0 0 0-.632-1.29a.074.074 0 0 0-.08-.037a19.791 19.791 0 0 0-4.885 1.515a.069.069 0 0 0-.032.059a19.342 19.342 0 0 0-1.622 5.585a.078.078 0 0 0 .028.083a17.9 17.9 0 0 0 4.1 2.624a.074.074 0 0 0 .089-.022a1.171 1.171 0 0 1 .494-.325a.074.074 0 0 0 .018-.111a12.112 12.112 0 0 0-1.88-1.084a.074.074 0 0 1-.038-.062a15.777 15.777 0 0 1 .413-2.91a.075.075 0 0 0 .043-.075a1.189 1.189 0 0 1 .018-.043a1.17 1.17 0 0 1 .1-.141a.071.071 0 0 0 .034-.044Z M12 16.117c-1.933 0-3.5-1.72-3.5-3.857c0-2.137 1.567-3.857 3.5-3.857s3.5 1.72 3.5 3.857c0 2.137-1.567 3.857-3.5 3.857Zm-4.136-3.857c0 1.233 1.042 2.232 2.327 2.232c.1 0 .2-.014.3-.028a.074.074 0 0 0 .048-.066a1.17 1.17 0 0 1-.162-1.164a1.17 1.17 0 0 1 .162-.164a.073.073 0 0 0 .066-.048a.074.074 0 0 0 .028-.153a2.321 2.321 0 0 0-2.763 1.562Zm8.272 0c0 1.233 1.042 2.232 2.327 2.232c.1 0 .2-.014.3-.028a.074.074 0 0 0 .048-.066a1.17 1.17 0 0 1-.162-1.164a1.17 1.17 0 0 1 .162-.164a.073.073 0 0 0 .066-.048a.074.074 0 0 0 .028-.153a2.321 2.321 0 0 0-2.763 1.562Z"/></svg>
                    <span>Discord ile Giriş Yap</span>
                </button>
            </div>
        </div>

        <div id="link-account-view" class="hidden flex items-center justify-center min-h-screen p-4">
            <div class="w-full max-w-sm card p-8 rounded-lg shadow-lg text-center">
                <img id="discord-avatar" class="w-20 h-20 rounded-full mx-auto mb-4 border-2 border-indigo-400">
                <h1 id="discord-username" class="text-xl font-bold text-white mb-2"></h1>
                <p class="text-gray-400 mb-6">Hesabını bağlamak için oyundaki ismini gir.</p>
                <form id="link-account-form">
                    <input id="in-game-name-link" type="text" placeholder="Oyun-içi İsim" class="form-input w-full p-3 rounded-md mb-4 text-center" required>
                    <button type="submit" class="w-full py-3 rounded-md font-bold text-white btn-primary">Hesabı Bağla</button>
                </form>
            </div>
        </div>
        
        <div id="dashboard-view" class="hidden w-full max-w-5xl mx-auto p-4 sm:p-6 md:p-8">
             <header class="flex flex-col sm:flex-row justify-between sm:items-center mb-8 pb-4 border-b border-gray-700">
                <div>
                    <p class="text-sm text-gray-400">Hoş Geldin,</p>
                    <h1 id="player-name" class="text-3xl font-bold text-white"></h1>
                </div>
                <div class="flex items-center gap-8 mt-4 sm:mt-0">
                    <div class="text-right">
                        <p class="text-sm text-gray-400">Guild Alış Oranı</p>
                        <p id="guild-purchase-rate" class="text-xl font-bold text-indigo-400">%80</p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-gray-400">Güncel Bakiyen</p>
                        <p id="player-balance" class="text-3xl font-bold text-green-400">0 Silver</p>
                    </div>
                </div>
            </header>
            
            <div class="mb-6 border-b border-gray-700">
                <nav class="flex space-x-4" aria-label="Tabs">
                    <button id="tab-action" class="tab-button active py-2 px-4 font-medium text-gray-400 border-b-2">Yeni İşlem</button>
                    <button id="tab-history" class="tab-button py-2 px-4 font-medium text-gray-400 border-b-2">İşlem Geçmişim</button>
                </nav>
            </div>

            <div id="action-content">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="space-y-8">
                        <div id="deposit-form-container" class="card p-6 rounded-lg">
                            <h2 class="text-xl font-bold mb-4">Loot Yatır</h2>
                            <form id="deposit-form" class="space-y-4">
                                <div>
                                    <label for="party-members" class="block text-sm font-medium mb-1 text-gray-300">Parti Üyeleri (Virgülle ayır)</label>
                                    <textarea id="party-members" rows="2" placeholder="Oyuncu1, Oyuncu2, Oyuncu3" class="form-textarea w-full p-2 rounded-md" required></textarea>
                                </div>
                                <div>
                                    <label for="estimated-value" class="block text-sm font-medium mb-1 text-gray-300">Tahmini Toplam Tab/Sandık Tutarı</label>
                                    <input type="number" id="estimated-value" placeholder="Örn: 15000000" class="form-input w-full p-2 rounded-md" required>
                                </div>
                                <div>
                                    <label for="repair-cost" class="block text-sm font-medium mb-1 text-gray-300">Toplam Tamir Masrafı (Repair Cost)</label>
                                    <input type="number" id="repair-cost" placeholder="Örn: 150000" class="form-input w-full p-2 rounded-md" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1 text-gray-300">Ekran Görüntüsü</label>
                                    <div id="file-drop-area" class="file-drop-area rounded-md p-6 text-center cursor-pointer">
                                        <p id="file-info" class="text-gray-400">Görseli buraya sürükle veya seçmek için tıkla</p>
                                        <input type="file" id="screenshot-file" class="hidden" accept="image/png, image/jpeg">
                                    </div>
                                </div>
                                <button type="submit" class="w-full py-2 rounded-md font-bold text-white btn-primary">Loot Yatırma Talebi Gönder</button>
                            </form>
                        </div>
                         <div class="card p-6 rounded-lg">
                            <h2 class="text-xl font-bold mb-4">Silver Çek</h2>
                            <form id="withdraw-form">
                                <div class="mb-4">
                                     <label for="withdraw-amount" class="block text-sm font-medium mb-1 text-gray-300">Çekilecek Tutar</label>
                                    <input id="withdraw-amount" type="number" placeholder="Örn: 5000000" class="form-input w-full p-2 rounded-md" required>
                                </div>
                                <button type="submit" class="w-full py-2 rounded-md font-bold text-white bg-green-600 hover:bg-green-700">Çekim Talebi Oluştur</button>
                            </form>
                        </div>
                    </div>
                    <div class="card p-6 rounded-lg">
                        <h2 class="text-xl font-bold mb-4">Örnek Satış Hesaplayıcı</h2>
                        <div class="space-y-4">
                            <div>
                                <label for="calc-total-value" class="block text-sm font-medium text-gray-300">Toplam Satış Tutarı</label>
                                <input type="number" id="calc-total-value" class="form-input w-full p-2 rounded-md mt-1" placeholder="10000000">
                            </div>
                            <div>
                                <label for="calc-repair-cost" class="block text-sm font-medium text-gray-300">Toplam Tamir Masrafı</label>
                                <input type="number" id="calc-repair-cost" class="form-input w-full p-2 rounded-md mt-1" placeholder="150000">
                            </div>
                            <div>
                                <label for="calc-party-count" class="block text-sm font-medium text-gray-300">Parti Üye Sayısı</label>
                                <input type="number" id="calc-party-count" class="form-input w-full p-2 rounded-md mt-1" placeholder="5">
                            </div>
                        </div>
                        <div class="mt-6 pt-4 border-t border-gray-600 space-y-2">
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-400">Kesinti Öncesi Net Tutar:</span>
                                <span id="calc-pre-tax" class="font-medium">0</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-400">Guild Kesintisi (<span id="calc-tax-rate-display">%20</span>):</span>
                                <span id="calc-tax-amount" class="font-medium text-red-400">- 0</span>
                            </div>
                             <div class="flex justify-between text-lg font-bold mt-2">
                                <span class="text-white">Oyuncu Başına Düşen:</span>
                                <span id="calc-net-payout" class="text-green-400">0 Silver</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="history-content" class="hidden">
                 <h2 class="text-xl font-bold mb-4 text-white">Tüm Taleplerim</h2>
                 <div id="user-history-list" class="space-y-4">
                    <p class="text-center text-gray-400">Henüz bir işlem yapmadınız.</p>
                 </div>
            </div>
        </div>
    </div>
    
    <div id="notification" class="fixed top-5 right-5 bg-green-500 text-white py-2 px-5 rounded-lg shadow-lg hidden"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, collection, serverTimestamp, query, where, onSnapshot, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // --- DISCORD AYARLARI ---
        const DISCORD_CLIENT_ID = "1412951643741356215"; // Discord Developer Portal'dan alınacak.

        const firebaseConfig = {
          apiKey: "AIzaSyC-yUauI8_nz4Ymc-BvHado5zoushIwQk4",
          authDomain: "bank-8738a.firebaseapp.com",
          projectId: "bank-8738a",
          storageBucket: "bank-8738a.firebasestorage.app",
          messagingSenderId: "157747262596",
          appId: "1:157747262596:web:1f60a45a33c0c5a702fed1",
          measurementId: "G-T8Z3R2X6DJ"
        };

        const appId = firebaseConfig.appId || 'default-albion-app'; 

        let app, auth, db, storage;
        let currentUser = null;
        let guildSettings = { taxRate: 0.20 };
        let tempDiscordUser = null; 

        const loginView = document.getElementById('login-view');
        const linkAccountView = document.getElementById('link-account-view');
        const dashboardView = document.getElementById('dashboard-view');
        const notification = document.getElementById('notification');
        const actionContent = document.getElementById('action-content');
        const historyContent = document.getElementById('history-content');
        const tabAction = document.getElementById('tab-action');
        const tabHistory = document.getElementById('tab-history');

        function formatSilver(num) {
            num = Number(num);
            if (isNaN(num)) return '0';

            if (Math.abs(num) >= 1000000) {
                return (num / 1000000).toLocaleString('tr-TR', { minimumFractionDigits: 0, maximumFractionDigits: 2 }) + 'M';
            }
            if (Math.abs(num) >= 1000) {
                return (num / 1000).toLocaleString('tr-TR', { minimumFractionDigits: 0, maximumFractionDigits: 2 }) + 'K';
            }
            return num.toLocaleString('tr-TR');
        }

        function showNotification(message, isError = false) {
            notification.textContent = message;
            notification.classList.toggle('bg-red-500', isError);
            notification.classList.toggle('bg-green-500', !isError);
            notification.classList.remove('hidden');
            setTimeout(() => notification.classList.add('hidden'), 3000);
        }

        // --- YENİ DISCORD GİRİŞ AKIŞI ---
        document.getElementById('discord-login-button').addEventListener('click', () => {
            const redirectUri = window.location.origin + window.location.pathname;
            const scope = 'identify';
            const authUrl = `https://discord.com/api/oauth2/authorize?client_id=${DISCORD_CLIENT_ID}&redirect_uri=${encodeURIComponent(redirectUri)}&response_type=token&scope=${scope}`;
            window.location.href = authUrl;
        });
        
        async function handleDiscordRedirect() {
            const fragment = new URLSearchParams(window.location.hash.substring(1));
            const accessToken = fragment.get('access_token');

            if (!accessToken) return; // Normal sayfa yüklenmesi, işlem yapma

            // URL'i temizle
            window.history.replaceState({}, document.title, window.location.pathname);

            try {
                const response = await fetch('https://discordapp.com/api/users/@me', {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                if (!response.ok) throw new Error('Discord bilgileri alınamadı.');
                
                const discordUser = await response.json();
                tempDiscordUser = discordUser; // Geçici olarak sakla

                // Bu Discord ID'si ile kayıtlı bir kullanıcı var mı?
                const usersRef = collection(db, `artifacts/${appId}/public/data/users`);
                const q = query(usersRef, where("discordId", "==", discordUser.id));
                const snapshot = await getDocs(q);

                if (snapshot.empty) {
                    // İlk defa giriş yapıyor, nick bağlama ekranını göster
                    loginView.classList.add('hidden');
                    linkAccountView.classList.remove('hidden');
                    document.getElementById('discord-avatar').src = `https://cdn.discordapp.com/avatars/${discordUser.id}/${discordUser.avatar}.png`;
                    document.getElementById('discord-username').textContent = discordUser.username;
                } else {
                    // Zaten kayıtlı, doğrudan giriş yap
                    currentUser = { id: snapshot.docs[0].id, ...snapshot.docs[0].data() };
                    localStorage.setItem('loggedInUser', JSON.stringify(currentUser));
                    showDashboard();
                }

            } catch (error) {
                console.error("Discord auth error:", error);
                showNotification("Discord ile giriş yapılırken bir hata oluştu.", true);
            }
        }

        document.getElementById('link-account-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const inGameName = document.getElementById('in-game-name-link').value.trim();
            if (!inGameName || !tempDiscordUser) return;

            const nameLower = inGameName.toLowerCase();
            const usersRef = collection(db, `artifacts/${appId}/public/data/users`);
            const batch = writeBatch(db);

            const qNick = query(usersRef, where("inGameName_lowercase", "==", nameLower));
            const nickSnapshot = await getDocs(qNick);

            if (nickSnapshot.empty) {
                return showNotification("Bu isim guild listesinde bulunamadı. Lütfen admin ile görüşün.", true);
            }

            const userDoc = nickSnapshot.docs[0];
            if (userDoc.data().discordId) {
                return showNotification("Bu oyun içi isim zaten başka bir Discord hesabına bağlı.", true);
            }

            batch.update(userDoc.ref, { 
                discordId: tempDiscordUser.id,
                discordUsername: tempDiscordUser.username 
            });

            const logRef = doc(collection(db, `artifacts/${appId}/public/data/registration_logs`));
            batch.set(logRef, {
                discordId: tempDiscordUser.id,
                discordUsername: tempDiscordUser.username,
                inGameName: userDoc.data().inGameName,
                timestamp: serverTimestamp()
            });

            await batch.commit();

            showNotification("Hesap başarıyla bağlandı!");
            currentUser = { id: userDoc.id, ...userDoc.data(), discordId: tempDiscordUser.id, discordUsername: tempDiscordUser.username };
            localStorage.setItem('loggedInUser', JSON.stringify(currentUser));
            linkAccountView.classList.add('hidden');
            showDashboard();
        });

        async function showDashboard() {
            loginView.classList.add('hidden');
            linkAccountView.classList.add('hidden');
            dashboardView.classList.remove('hidden');
            document.getElementById('player-name').textContent = currentUser.inGameName;
            
            await loadGuildSettings();

            const userRef = doc(db, `artifacts/${appId}/public/data/users`, currentUser.id);
            onSnapshot(userRef, (doc) => {
                if(doc.exists()){
                    const newBalance = doc.data().balance || 0;
                    currentUser.balance = newBalance;
                    document.getElementById('player-balance').textContent = `${formatSilver(newBalance)} Silver`;
                }
            });
            listenToUserHistory();
        }
        
        document.getElementById('deposit-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const button = e.target.querySelector('button[type="submit"]');
            const fileInput = document.getElementById('screenshot-file');
            const file = fileInput.files[0];
            const partyMembers = document.getElementById('party-members').value.split(',').map(m => m.trim()).filter(m => m);
            const repairCost = parseInt(document.getElementById('repair-cost').value) || 0;
            const estimatedValue = parseInt(document.getElementById('estimated-value').value) || 0;

            if (partyMembers.length === 0) return showNotification("Parti üyelerini girin.", true);
            if (!file) return showNotification("Ekran görüntüsü seçin.", true);

            button.disabled = true;
            button.textContent = "Yükleniyor...";

            try {
                const authUser = auth.currentUser;
                if (!authUser) throw new Error("Kimlik doğrulaması yapılamadı. Lütfen sayfayı yenileyin.");

                const filePath = `deposits/${authUser.uid}/${Date.now()}-${file.name}`;
                const storageRef = ref(storage, filePath);
                const uploadResult = await uploadBytes(storageRef, file);
                const imageUrl = await getDownloadURL(uploadResult.ref);

                await addDoc(collection(db, `artifacts/${appId}/public/data/deposits`), {
                    submitterId: currentUser.id,
                    submitterName: currentUser.inGameName,
                    partyMembers: partyMembers,
                    estimatedValue: estimatedValue,
                    repairCost: repairCost,
                    imageUrl: imageUrl,
                    status: 'pending',
                    submittedAt: serverTimestamp()
                });
                
                showNotification("Loot yatırma talebi başarıyla gönderildi.");
                e.target.reset();
                document.getElementById('file-info').textContent = 'Görseli buraya sürükle veya seçmek için tıkla';
            } catch (error) {
                console.error("Deposit error:", error);
                showNotification("Talep gönderilirken hata oluştu.", true);
            } finally {
                button.disabled = false;
                button.textContent = "Loot Yatırma Talebi Gönder";
            }
        });

        document.getElementById('withdraw-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const amount = parseInt(document.getElementById('withdraw-amount').value);
            if (!amount || amount <= 0) return showNotification("Geçerli bir tutar girin.", true);
            if (amount > currentUser.balance) return showNotification("Bakiyeniz yetersiz.", true);
            
            await addDoc(collection(db, `artifacts/${appId}/public/data/withdrawals`), {
                requesterId: currentUser.id,
                requesterName: currentUser.inGameName,
                amount: amount,
                status: 'pending',
                requestedAt: serverTimestamp()
            });

            showNotification("Çekim talebi oluşturuldu.");
            e.target.reset();
        });

        function listenToUserHistory() {
            const historyListEl = document.getElementById('user-history-list');
            const renderHistory = async () => {
                const depositsRef = collection(db, `artifacts/${appId}/public/data/deposits`);
                const withdrawalsRef = collection(db, `artifacts/${appId}/public/data/withdrawals`);
                const depositsQuery = query(depositsRef, where("submitterId", "==", currentUser.id));
                const withdrawalsQuery = query(withdrawalsRef, where("requesterId", "==", currentUser.id));
                const [depositsSnapshot, withdrawalsSnapshot] = await Promise.all([ getDocs(depositsQuery), getDocs(withdrawalsQuery) ]);
                const deposits = depositsSnapshot.docs.map(doc => ({ type: 'Loot Yatırma', ...doc.data() }));
                const withdrawals = withdrawalsSnapshot.docs.map(doc => ({ type: 'Silver Çekim', ...doc.data() }));
                const allHistory = [...deposits, ...withdrawals].sort((a, b) => {
                    const dateA = a.processedAt || a.submittedAt || a.requestedAt;
                    const dateB = b.processedAt || b.submittedAt || b.requestedAt;
                    if (!dateA || !dateB) return 0;
                    return dateB.toDate() - dateA.toDate();
                });
                if (allHistory.length === 0) {
                    historyListEl.innerHTML = `<p class="text-center text-gray-400">Henüz bir işlem yapmadınız.</p>`;
                    return;
                }
                historyListEl.innerHTML = allHistory.map(item => {
                    const date = (item.processedAt || item.submittedAt || item.requestedAt)?.toDate()?.toLocaleString('tr-TR') || 'Tarih Yok';
                    let statusClass, statusText;
                    switch (item.status) {
                        case 'completed': statusClass = 'bg-green-500'; statusText = 'Onaylandı'; break;
                        case 'rejected': statusClass = 'bg-red-500'; statusText = 'Reddedildi'; break;
                        default: statusClass = 'bg-yellow-500'; statusText = 'Beklemede';
                    }
                    const reasonHtml = item.status === 'rejected' && item.rejectionReason ? `<p class="text-xs text-red-400 mt-1">Neden: ${item.rejectionReason}</p>` : '';
                    let detailsHtml = '';
                    if (item.type === 'Loot Yatırma') {
                        const estimatedValueText = `Tahmini Değer: <span class="font-semibold">${formatSilver(item.estimatedValue || 0)}</span>`;
                        const repairCostText = `Tamir: <span class="font-semibold">${formatSilver(item.repairCost || 0)}</span>`;
                        const screenshotLink = item.imageUrl ? `<a href="${item.imageUrl}" target="_blank" class="text-indigo-400 hover:underline">Görsel</a>` : '';
                        detailsHtml = `<div class="text-xs text-gray-400 mt-1 flex gap-4">${estimatedValueText} | ${repairCostText} | ${screenshotLink}</div>`;
                    }

                    const amountText = item.type === 'Silver Çekim' ? `${formatSilver(item.amount || 0)} Silver` : `Parti: ${(item.partyMembers || []).join(', ')}`;

                    return `
                        <div class="card p-4 rounded-md">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="font-bold">${item.type}</p>
                                    <p class="text-sm text-gray-300">${amountText}</p>
                                    ${detailsHtml}
                                    ${reasonHtml}
                                </div>
                                <div class="text-right flex-shrink-0 ml-4">
                                     <span class="text-xs font-bold text-white px-2 py-1 rounded-full ${statusClass}">${statusText}</span>
                                     <p class="text-xs text-gray-400 mt-2">${date}</p>
                                </div>
                            </div>
                        </div>`;
                }).join('');
            };
            onSnapshot(query(collection(db, `artifacts/${appId}/public/data/deposits`), where("submitterId", "==", currentUser.id)), renderHistory);
            onSnapshot(query(collection(db, `artifacts/${appId}/public/data/withdrawals`), where("requesterId", "==", currentUser.id)), renderHistory);
        }
        
        const calcInputs = ['calc-total-value', 'calc-repair-cost', 'calc-party-count'];
        calcInputs.forEach(id => document.getElementById(id).addEventListener('input', calculatePayout));
        
        function calculatePayout() {
            const totalValue = parseInt(document.getElementById('calc-total-value').value) || 0;
            const repairCost = parseInt(document.getElementById('calc-repair-cost').value) || 0;
            const partyCount = parseInt(document.getElementById('calc-party-count').value) || 1;
            
            const preTax = totalValue - repairCost;
            const taxAmount = preTax > 0 ? preTax * guildSettings.taxRate : 0;
            const finalAmount = preTax - taxAmount;
            const perPlayer = partyCount > 0 ? finalAmount / partyCount : 0;
            
            document.getElementById('calc-pre-tax').textContent = formatSilver(preTax);
            document.getElementById('calc-tax-amount').textContent = `- ${formatSilver(taxAmount)}`;
            document.getElementById('calc-net-payout').textContent = `${formatSilver(perPlayer)} Silver`;
        }
        
        async function loadGuildSettings() {
            const settingsRef = doc(db, `artifacts/${appId}/public/data/settings`, 'guild');
            const docSnap = await getDoc(settingsRef);
            if (docSnap.exists() && docSnap.data().taxRate !== undefined) {
                guildSettings = docSnap.data();
            }
            const purchaseRate = Math.round((1 - guildSettings.taxRate) * 100);
            document.getElementById('guild-purchase-rate').textContent = `Alış: %${purchaseRate}`;
            document.getElementById('calc-tax-rate-display').textContent = `%${(guildSettings.taxRate * 100).toFixed(0)}`;
            calculatePayout();
        }

        tabAction.addEventListener('click', () => {
            tabAction.classList.add('active'); tabHistory.classList.remove('active');
            actionContent.classList.remove('hidden'); historyContent.classList.add('hidden');
        });
        tabHistory.addEventListener('click', () => {
            tabHistory.classList.add('active'); tabAction.classList.remove('active');
            historyContent.classList.remove('hidden'); actionContent.classList.add('hidden');
        });
        const dropArea = document.getElementById('file-drop-area');
        const fileInput = document.getElementById('screenshot-file');
        const fileInfo = document.getElementById('file-info');
        dropArea.addEventListener('click', () => fileInput.click());
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => dropArea.addEventListener(eventName, (e) => { e.preventDefault(); e.stopPropagation(); }));
        ['dragenter', 'dragover'].forEach(eventName => dropArea.addEventListener(eventName, () => dropArea.classList.add('highlight')));
        ['dragleave', 'drop'].forEach(eventName => dropArea.addEventListener(eventName, () => dropArea.classList.remove('highlight')));
        dropArea.addEventListener('drop', (e) => {
            fileInput.files = e.dataTransfer.files;
            fileInfo.textContent = fileInput.files[0].name;
        });
        fileInput.addEventListener('change', () => {
             if(fileInput.files.length > 0) fileInfo.textContent = fileInput.files[0].name;
        });
        
        async function initializeAppAndAuth() {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            storage = getStorage(app);
            try {
                await signInAnonymously(auth); // Arka plan işlemleri için anonim oturum
                const savedUser = localStorage.getItem('loggedInUser');
                if (savedUser) {
                    currentUser = JSON.parse(savedUser);
                    showDashboard();
                } else {
                    await handleDiscordRedirect();
                }
            } catch (error) { console.error("Auth error", error); }
        }

        initializeAppAndAuth();
    </script>
</body>
</html>

