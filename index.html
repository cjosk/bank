<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Klan Kasası</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #1a202c; color: #e2e8f0; }
        .form-input, .form-textarea { background-color: #2d3748; border-color: #4a5568; color: #e2e8f0; }
        .card { background-color: #2d3748; border: 1px solid #4a5568; }
        .btn-primary { background-color: #4f46e5; }
        .btn-primary:hover { background-color: #4338ca; }
        .file-drop-area { border: 2px dashed #4a5568; }
        .file-drop-area.highlight { border-color: #a0aec0; background-color: #4a5568; }
    </style>
</head>
<body class="antialiased">

    <div id="player-app" class="min-h-screen">
        <div id="login-view" class="flex items-center justify-center min-h-screen p-4">
            <div class="w-full max-w-sm card p-8 rounded-lg shadow-lg text-center">
                <h1 class="text-2xl font-bold text-white mb-2">Klan Kasasına Hoş Geldin</h1>
                <p class="text-gray-400 mb-6">Lütfen oyundaki ismini girerek devam et.</p>
                <form id="login-form">
                    <input id="in-game-name" type="text" placeholder="Oyun-içi İsim" class="form-input w-full p-3 rounded-md mb-4 text-center" required>
                    <button type="submit" class="w-full py-3 rounded-md font-bold text-white btn-primary">Giriş Yap</button>
                </form>
            </div>
        </div>

        <div id="dashboard-view" class="hidden w-full max-w-4xl mx-auto p-4 sm:p-6 md:p-8">
            <header class="flex flex-col sm:flex-row justify-between sm:items-center mb-8 pb-4 border-b border-gray-700">
                <div>
                    <p class="text-sm text-gray-400">Hoş Geldin,</p>
                    <h1 id="player-name" class="text-3xl font-bold text-white"></h1>
                </div>
                <div class="text-left sm:text-right mt-4 sm:mt-0">
                    <p class="text-sm text-gray-400">Güncel Bakiyen</p>
                    <p id="player-balance" class="text-3xl font-bold text-green-400">0 Silver</p>
                </div>
            </header>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div id="deposit-form-container" class="card p-6 rounded-lg">
                    <h2 class="text-xl font-bold mb-4">Loot Yatır</h2>
                    <form id="deposit-form">
                        <div class="mb-4">
                            <label for="party-members" class="block text-sm font-medium mb-1 text-gray-300">Parti Üyeleri (Virgülle ayır, kendini de ekle)</label>
                            <textarea id="party-members" rows="3" placeholder="Oyuncu1, Oyuncu2, Oyuncu3" class="form-textarea w-full p-2 rounded-md" required></textarea>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-1 text-gray-300">Ekran Görüntüsü</label>
                            <div id="file-drop-area" class="file-drop-area rounded-md p-6 text-center cursor-pointer">
                                <p id="file-info" class="text-gray-400">Görseli buraya sürükle veya seçmek için tıkla</p>
                                <input type="file" id="screenshot-file" class="hidden" accept="image/png, image/jpeg">
                            </div>
                        </div>
                        <button type="submit" class="w-full py-2 rounded-md font-bold text-white btn-primary">Talebi Gönder</button>
                    </form>
                </div>

                <div class="card p-6 rounded-lg">
                    <h2 class="text-xl font-bold mb-4">Silver Çek</h2>
                    <form id="withdraw-form">
                        <div class="mb-4">
                             <label for="withdraw-amount" class="block text-sm font-medium mb-1 text-gray-300">Çekilecek Tutar</label>
                            <input id="withdraw-amount" type="number" placeholder="Örn: 5000000" class="form-input w-full p-2 rounded-md" required>
                        </div>
                        <button type="submit" class="w-full py-2 rounded-md font-bold text-white bg-green-600 hover:bg-green-700">Çekim Talebi Oluştur</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <div id="notification" class="fixed top-5 right-5 bg-green-500 text-white py-2 px-5 rounded-lg shadow-lg hidden"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, addDoc, collection, serverTimestamp, query, where, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // --- FIREBASE YAPILANDIRMASI ---
        const firebaseConfig = {
          apiKey: "AIzaSyC-yUauI8_nz4Ymc-BvHado5zoushIwQk4",
          authDomain: "bank-8738a.firebaseapp.com",
          projectId: "bank-8738a",
          storageBucket: "bank-8738a.firebasestorage.app",
          messagingSenderId: "157747262596",
          appId: "1:157747262596:web:1f60a45a33c0c5a702fed1",
          measurementId: "G-T8Z3R2X6DJ"
        };

        const appId = firebaseConfig.appId || 'default-albion-app'; 

        let app, auth, db, storage;
        let currentUser = null;

        const loginView = document.getElementById('login-view');
        const dashboardView = document.getElementById('dashboard-view');
        const notification = document.getElementById('notification');

        function showNotification(message, isError = false) {
            notification.textContent = message;
            notification.classList.toggle('bg-red-500', isError);
            notification.classList.toggle('bg-green-500', !isError);
            notification.classList.remove('hidden');
            setTimeout(() => notification.classList.add('hidden'), 3000);
        }

        async function loginOrCreateUser(name) {
            const nameLower = name.toLowerCase();
            const usersRef = collection(db, `artifacts/${appId}/public/data/users`);
            const q = query(usersRef, where("inGameName_lowercase", "==", nameLower));
            const snapshot = await getDocs(q);

            if (snapshot.empty) {
                return showNotification("Bu isim sistemde kayıtlı değil. Lütfen admin ile görüşün.", true);
            }
            
            const userDoc = snapshot.docs[0];
            currentUser = { id: userDoc.id, ...userDoc.data() };
            localStorage.setItem('loggedInUser', JSON.stringify(currentUser));
            showDashboard();
        }

        function showDashboard() {
            loginView.classList.add('hidden');
            dashboardView.classList.remove('hidden');
            document.getElementById('player-name').textContent = currentUser.inGameName;
            
            const userRef = doc(db, `artifacts/${appId}/public/data/users`, currentUser.id);
            onSnapshot(userRef, (doc) => {
                if(doc.exists()){
                    const newBalance = doc.data().balance || 0;
                    currentUser.balance = newBalance;
                    document.getElementById('player-balance').textContent = `${newBalance.toLocaleString('tr-TR')} Silver`;
                }
            });
        }
        
        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const name = document.getElementById('in-game-name').value.trim();
            if (name) loginOrCreateUser(name);
        });

        document.getElementById('deposit-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const button = e.target.querySelector('button[type="submit"]');
            const fileInput = document.getElementById('screenshot-file');
            const file = fileInput.files[0];
            const partyMembers = document.getElementById('party-members').value.split(',').map(m => m.trim()).filter(m => m);

            if (partyMembers.length === 0) return showNotification("Parti üyelerini girin.", true);
            if (!file) return showNotification("Ekran görüntüsü seçin.", true);

            button.disabled = true;
            button.textContent = "Yükleniyor...";

            try {
                // 1. Görseli Firebase Storage'a yükle
                const filePath = `deposits/${currentUser.id}/${Date.now()}-${file.name}`;
                const storageRef = ref(storage, filePath);
                const uploadResult = await uploadBytes(storageRef, file);
                
                // 2. Yüklenen görselin public URL'ini al
                const imageUrl = await getDownloadURL(uploadResult.ref);

                // 3. Firestore'a talebi doğru URL ile kaydet
                await addDoc(collection(db, `artifacts/${appId}/public/data/deposits`), {
                    submitterId: currentUser.id,
                    submitterName: currentUser.inGameName,
                    partyMembers: partyMembers,
                    imageUrl: imageUrl, // <-- DOĞRU URL BURAYA EKLENDİ
                    status: 'pending',
                    submittedAt: serverTimestamp()
                });
                
                showNotification("Loot yatırma talebi başarıyla gönderildi.");
                e.target.reset();
                document.getElementById('file-info').textContent = 'Görseli buraya sürükle veya seçmek için tıkla';
            } catch (error) {
                console.error("Deposit error:", error);
                showNotification("Talep gönderilirken hata oluştu.", true);
            } finally {
                button.disabled = false;
                button.textContent = "Talebi Gönder";
            }
        });

        document.getElementById('withdraw-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const amount = parseInt(document.getElementById('withdraw-amount').value);
            if (!amount || amount <= 0) return showNotification("Geçerli bir tutar girin.", true);
            if (amount > currentUser.balance) return showNotification("Bakiyeniz yetersiz.", true);
            
            await addDoc(collection(db, `artifacts/${appId}/public/data/withdrawals`), {
                requesterId: currentUser.id,
                requesterName: currentUser.inGameName,
                amount: amount,
                status: 'pending',
                requestedAt: serverTimestamp()
            });

            showNotification("Çekim talebi oluşturuldu.");
            e.target.reset();
        });

        // --- Dosya Sürükle-Bırak Alanı ---
        const dropArea = document.getElementById('file-drop-area');
        const fileInput = document.getElementById('screenshot-file');
        const fileInfo = document.getElementById('file-info');

        dropArea.addEventListener('click', () => fileInput.click());
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, (e) => {
                e.preventDefault();
                e.stopPropagation();
            }, false);
        });
        ['dragenter', 'dragover'].forEach(eventName => {
            dropArea.addEventListener(eventName, () => dropArea.classList.add('highlight'), false);
        });
        ['dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, () => dropArea.classList.remove('highlight'), false);
        });

        dropArea.addEventListener('drop', (e) => {
            fileInput.files = e.dataTransfer.files;
            fileInfo.textContent = fileInput.files[0].name;
        });
        fileInput.addEventListener('change', () => {
             if(fileInput.files.length > 0) fileInfo.textContent = fileInput.files[0].name;
        });
        
        // --- UYGULAMA BAŞLANGICI ---
        async function initializeAppAndAuth() {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            storage = getStorage(app); // Storage servisini başlat
            try {
                await signInAnonymously(auth);
                const savedUser = localStorage.getItem('loggedInUser');
                if(savedUser){
                    currentUser = JSON.parse(savedUser);
                    showDashboard();
                }
            } catch (error) { console.error("Auth error", error); }
        }

        initializeAppAndAuth();
    </script>
</body>
</html>

